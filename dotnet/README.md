# Использование dotnet-sdk Для Работы с S3 Хранилищем Timeweb Cloud
## Описание
> [!WARNING]
> Версия NuGet пакета `AWS.SDK` должна быть `<=3.5.10.2`, поскольку в Timeweb не поддерживает самые последние версии .NET клиентов. Предположительно, это связано с обновлением не самого S3 API, который так и остался в версии `2006-03-01`, но с новыми требованиями к сети (HTTP/2), `nullable` поля и др. 

Приложение показывает использование S3 хранилища Timeweb Cloud в `dotnet`, при запуске будут выполнены следующие команды:
1. Создание бакета (если уже существует - вернет детали существующего бакета)
1. Регион бакета
1. Список бакетов
1. Отправка текста в файл
1. Отправка файла
1. Получение списка объектов
1. Скачивание объекта
1. Получение метаданных объекта
1. Копирование файла
1. Удаление всех объектов
1. Удаление бакета

> [!CAUTION]
> Во время выполнения этой программы будет выполнено удаление бакета и всех файлов в нем! Будьте аккуратны когда указываете имя существующего бакета в `.env`

При успешном завершении операции будет выведен ответ от S3 API в формате JSON, при неудаче - детали ошибки. Если в качестве ответа приходит файл, будет выведено его содержимое (поддерживаются только текстовые файлы).

В качестве клиента к S3 хранилищем Timeweb Cloud используется официальный SDK от Amazon (`AWS.SDK`) версии `3.5.10.2`, ендпоинт Timeweb Cloud S3 API  `https://s3.twcstorage.ru`  
В [sample.cs](./src/sample.cs) описаны основные ендпоинты для работы с API, для запуска потребуется переименовать [.env.example](./src/.env.example) в `.env` и вписать настоящие данные для подключения к S3 хранилищу Timeweb Cloud, которые можно найти во вкладке `Дашборд` в разделе `Хранилище S3` в личном кабинете Timeweb Cloud.

Больше информации об объектном S3 хранилище Timeweb Cloud в [документации](https://timeweb.cloud/docs/s3-storage).

## Требования
- Linux/Windows/macOS
- dotnet 10/Docker
### Запуск через CLI
Для локального запуска требуется установка [dotnet SDK версии >=10](https://dotnet.microsoft.com/en-us/download/dotnet/10.0) и заполненный `.env` файл.

После установки достаточно выполнить эту команду в любой консоли (убедитесь что выполняете команду из папки ./dotnet/src):
```bash
dotnet run sample.cs
```

### Запуск через Docker
Для запуска и сборки через Docker требуется установка [Docker](https://www.docker.com/) и заполненный `.env` файл.

В проекте присутствует [Dockerfile](./Dockerfile) с двумя стейджами для уменьшения размера docker image:  

**Stage 1**: Использует dotnet 10.0 SDK и конвертирует файл [sample.cs](./src/sample.cs) в классический формат проекта dotnet чтобы иметь возможность собрать исполняемый файл (пока что для direct file запуска требуется SDK, он довольно тяжеловесный). Из-за требований S3 библиотеки к функциям рефлексии, ради экономии времени было решено не идти по пути AOT (размер докер образа можно было бы уменьшить до ~<10mb)  
**Stage 2**: Копирует компилированные файлы в исполняемый образ и создает `ENTRYPOINT`

Для сборки проекта достаточно выполнить следующую CLI команду, находясь в папке `./dotnet`:
```bash
docker build -t dotnet-s3-example:latest ./src
```

Для запуска приложения после сборки:
```bash
docker run --rm -it --name dotnet-s3-example --env-file ./src/.env dotnet-s3-example:latest
```

### Запуск через Visual Studio Code
> [!NOTE]
> Так как приложение писалось когда .NET 10 был еще в Preview 4, запуск через F5 с дебаггером на тот момент не был реализован для direct file приложений, поэтому опция с дебагом отсутствует так же как и файл launch.json

Для Visual Studio Code поддерживаются 2 варианта запуска:
1. [Локальный запуск](#запуск-через-cli)
2. [Запуск через Docker](#запуск-через-docker)

Так как это просто шорткаты для двух описанных выше вариантов запуска, при выборе определенного варианта все требования необходимо удовлетворить.

Для удобства в проекте создан файл `tasks.json` благодаря которому программу можно запустить через сочетание клавиш `CTRL + SHIFT + B` для Windows и `CMD + SHIFT + B` для MacOS -> `Run .NET Sample`